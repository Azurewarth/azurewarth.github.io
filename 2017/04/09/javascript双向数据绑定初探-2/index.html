<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"name="viewport">
  <title>Azurewarth</title>
  <link rel="stylesheet" href="/./css/style.css">
  <script src="/./js/canvas.js"></script>
</head>
  <body>
    <header class="header">
    <div class="blog-title">
        <a href="https://github.com/Azurewarth" class="logo">Azurewarth</a>
    </div>
    <div class="blog-subtitle">
        resume &amp; blog -- 247
    </div>
    <ul class="menu">
        
        <li class="menu-item">
            <a href="/" class="menu-item-link">Home</a>
        </li>
        
        <li class="menu-item">
            <a href="/archives" class="menu-item-link">Archive</a>
        </li>
        
        <li class="menu-item">
            <a href="https://github.com/Azurewarth" class="menu-item-link">Github</a>
        </li>
        
    </ul> 
</header> 

    <main class="main">
      <article class="post">
  <div class="post-title">
    <h2 class="title">javascript双向数据绑定初探(2)</h2>
  </div>
   <div class="post-meta">
    <span class="post-time"></span>
  </div>
  <div class="post-content">
    <h6 id="使用Object-defineProperty-进行定义对象属性之后，设置set和get可以实现简单事件绑定。但是，如果存在多个属性都需要进行绑定，那么就要实现封装。"><a href="#使用Object-defineProperty-进行定义对象属性之后，设置set和get可以实现简单事件绑定。但是，如果存在多个属性都需要进行绑定，那么就要实现封装。" class="headerlink" title="使用Object.defineProperty()进行定义对象属性之后，设置set和get可以实现简单事件绑定。但是，如果存在多个属性都需要进行绑定，那么就要实现封装。"></a>使用<strong><em>Object.defineProperty()</em></strong>进行定义对象属性之后，设置<strong><em>set</em></strong>和<strong><em>get</em></strong>可以实现简单事件绑定。但是，如果存在多个属性都需要进行绑定，那么就要实现封装。</h6><a id="more"></a>
<p>新建js文件，以<strong><em>vue</em></strong>为例子，那我们的js文件就叫，<strong><em>selfVue.js</em></strong>。（观察者模式observe先不讨论，没搞清楚还）</p>
<p>html如下，引入<strong><em>selfVue.js</em></strong>文件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"msg1"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-text</span>=<span class="string">"msg1"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"msg2"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-text</span>=<span class="string">"msg2"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./selfVue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript"></span></div><div class="line">    <span class="keyword">var</span> model = &#123;</div><div class="line">      msg1: <span class="string">"this is selfVue data"</span>,</div><div class="line">      msg2: <span class="string">"this is othre selfVue data"</span>,</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">var</span> selfVue = <span class="keyword">new</span> SelfVue(&#123;</div><div class="line">      el: <span class="string">"#app"</span>,</div><div class="line">      data: model,</div><div class="line">    &#125;);</div><div class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<p>那就是参照<strong><em>vue</em></strong>的思想来封装实现。以<strong><em>msg1</em></strong>和<strong><em>msg2</em></strong>两个绑定属性为例子。</p>
<p>首先，需要创建一个对象，实现类似<strong><em>vue</em></strong>的包装结构。</p>
<p>一下是<strong><em>selfVue.js</em></strong>文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> SelfVue = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">vue</span> </span>&#123;</div><div class="line">        <span class="keyword">constructor</span>(options) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> prop <span class="keyword">in</span> options) &#123;</div><div class="line">                <span class="keyword">this</span>[prop] = options[prop];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.el = <span class="built_in">document</span>.querySelector(<span class="keyword">this</span>.el);</div><div class="line">            <span class="built_in">console</span>.log(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> vue;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure>
<p>实现一个立即执行函数，类名<strong><em>vue</em></strong>（取什么都行），最后把类<strong>return</strong>出去，取一个别名，叫<strong><em>SelfVue</em></strong>。将<strong><em>option</em></strong>传入之后，用<strong>dom</strong>元素代替<strong>el</strong>属性的值，在控制台输出，看看是否再创建<strong><em>SelfVue</em></strong>的时候，是否已经传入<strong>options</strong>。</p>
<p>如下图。</p>
<p><img src="/2017/04/09/javascript双向数据绑定初探-2/vue1.png" width="600px"></p>
<p>按照实现思路，必须监听所有拥有<strong><em>v-model</em></strong>属性的元素变化。在<strong><em>selfVue.js</em></strong>中加入<strong>onkeyup</strong>监听。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> SelfVue = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">vue</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(options) &#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> prop <span class="keyword">in</span> options) &#123;</div><div class="line">            <span class="keyword">this</span>[prop] = options[prop];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.el = <span class="built_in">document</span>.querySelector(<span class="keyword">this</span>.el);</div><div class="line">        <span class="keyword">var</span> data = <span class="keyword">this</span>.data;</div><div class="line">        <span class="keyword">var</span> models = <span class="keyword">this</span>.el.querySelectorAll(<span class="string">"[v-model]"</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; models.length; i++) &#123;</div><div class="line">            models[i].onkeyup = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                data[<span class="keyword">this</span>.getAttribute(<span class="string">"v-model"</span>)] = <span class="keyword">this</span>.value;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> vue;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure>
<p>最后通过<strong><em>Object.defineProperty()</em></strong>实现绑定。在<strong><em>vue</em></strong>类中，添加<strong><em>observer</em></strong>方法（非深度观察者方法），然后要在<strong><em>constructor</em></strong>构建时调用，实现创建对象的同时实现绑定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> SelfVue = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">vue</span> </span>&#123;</div><div class="line">      <span class="keyword">constructor</span>(options) &#123;</div><div class="line">          <span class="keyword">for</span>(<span class="keyword">var</span> prop <span class="keyword">in</span> options) &#123;</div><div class="line">              <span class="keyword">this</span>[prop] = options[prop];</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">this</span>.el = <span class="built_in">document</span>.querySelector(<span class="keyword">this</span>.el);</div><div class="line">          <span class="keyword">var</span> data = <span class="keyword">this</span>.data;</div><div class="line">          <span class="keyword">var</span> models = <span class="keyword">this</span>.el.querySelectorAll(<span class="string">"[v-model]"</span>);</div><div class="line">          <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; models.length; i++) &#123;</div><div class="line">              models[i].onkeyup = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                  data[<span class="keyword">this</span>.getAttribute(<span class="string">"v-model"</span>)] = <span class="keyword">this</span>.value;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">this</span>.observer();</div><div class="line">      &#125;</div><div class="line">      observer() &#123;</div><div class="line">          <span class="keyword">var</span> el = <span class="keyword">this</span>.el;</div><div class="line">          <span class="keyword">for</span>(<span class="keyword">let</span> prop <span class="keyword">in</span> <span class="keyword">this</span>.data) &#123;</div><div class="line">              <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.data, prop, &#123;</div><div class="line">                  <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">                  <span class="attr">get</span>: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">                      <span class="keyword">return</span> <span class="keyword">this</span>.value;</div><div class="line">                  &#125;,</div><div class="line">                  <span class="attr">set</span>: <span class="function">(<span class="params">newValue</span>) =&gt;</span> &#123;</div><div class="line">                      <span class="keyword">var</span> texts = el.querySelectorAll(<span class="string">"[v-text="</span>+prop+<span class="string">"]"</span>);</div><div class="line">                      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; texts.length; i++) &#123;</div><div class="line">                          texts[i].innerHTML = newValue;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">var</span> models = el.querySelectorAll(<span class="string">"[v-model="</span>+prop+<span class="string">"]"</span>);</div><div class="line">                      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; models.length; i++) &#123;</div><div class="line">                          models[i].value = newValue;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">this</span>.value = newValue;</div><div class="line">                  &#125;</div><div class="line">              &#125;)</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> vue;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure>
<p>html中添加一下对<strong>model</strong>的初始化。并对两个帮点元素做了区分。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></div><div class="line">      msg1:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"msg1"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-text</span>=<span class="string">"msg1"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">      msg2:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"msg2"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-text</span>=<span class="string">"msg2"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./selfVue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript"></span></div><div class="line">    <span class="keyword">var</span> model = &#123;</div><div class="line">      msg1: <span class="string">"this is selfVue data"</span>,</div><div class="line">      msg2: <span class="string">"this is other selfVue data"</span>,</div><div class="line">    &#125;;</div><div class="line">  	<span class="keyword">var</span> selfVue = <span class="keyword">new</span> SelfVue(&#123;</div><div class="line">      el: <span class="string">"#app"</span>,</div><div class="line">      data: model,</div><div class="line">  	&#125;);</div><div class="line">  	model.msg1 = <span class="number">123</span>;</div><div class="line">  	model.msg2 = <span class="number">456</span>;</div><div class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<p>刷新页面获得如下效果。</p>
<p><img src="/2017/04/09/javascript双向数据绑定初探-2/vue2.png" width="600px"></p>
<p>然后先在<strong>msg1</strong>中输入，可实现绑定效果。</p>
<p><img src="/2017/04/09/javascript双向数据绑定初探-2/vue3.png" width="600px"></p>
<p>然后在<strong>msg2</strong>中输入，可实现绑定效果。</p>
<p><img src="/2017/04/09/javascript双向数据绑定初探-2/vue4.png" width="600px"></p>

  </div>
</article>
    </main>
    <div>
	<canvas id="background-canvas"></canvas>
</div>
  </body>
</html>